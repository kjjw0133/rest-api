use `chating app`;

create table user(
userno int AUTO_INCREMENT primary key ,
id varchar(20) not null unique ,
pw varchar(255) not null,
salt varchar(255),
name varchar(100) not null,
email varchar(30) not null check(email like '%@%'),
role varchar(20) default 'user', /* 권한 user,admin */  
is_logged_in TINYINT(1) DEFAULT 0 COMMENT '로그인 상태',
session_id VARCHAR(100) NULL COMMENT '세션 ID',
login_time DATETIME NULL COMMENT '로그인 시간',
last_activity DATETIME NULL COMMENT '마지막 활동 시간',
created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '계정 생성일',
updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정일',
is_active TINYINT(1) DEFAULT 1 COMMENT '계정 활성화',
readmessage int(1) comment '메시지 읽음 처리'
);

CREATE TABLE friend(
  request_id INT AUTO_INCREMENT PRIMARY KEY,
  requester_id VARCHAR(20) COMMENT '친구 요청을 보낸 user id (A)',
  receiver_id VARCHAR(20) COMMENT '친구 요청을 받은 user id (B)',
  status INT DEFAULT 0 COMMENT '0: 대기, 1: 초대 보냄, 2: 초대 수락(친구 상태)',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '요청 시간',
  CHECK(status < 3 AND status >= 0),
  FOREIGN KEY (requester_id) REFERENCES user(id) ON DELETE CASCADE,
  FOREIGN KEY (receiver_id) REFERENCES user(id) ON DELETE CASCADE,
  -- 중복 친구 관계 방지
  UNIQUE KEY unique_friendship (requester_id, receiver_id)
);

CREATE INDEX idx_friend_status ON friend(status);
CREATE INDEX idx_friend_requester ON friend(requester_id);
CREATE INDEX idx_friend_receiver ON friend(receiver_id);

create table chat(
ChatRoomId int AUTO_INCREMENT primary key, /* 방 번호 */
num int default 1/* 인원수 */,
ChatType int not null check (ChatType in(1, 2)) default 2, /* 1: 일반 채팅(비번 있음) , 2 : 공개 채팅 비번 x */
chatpw varchar(50) default '',
chatroomname varchar(50) not null
);

create table chating(
c_no int AUTO_INCREMENT primary key,
ChatRoomId int not null,
userno int,
contents varchar(100), /* 글 내용 */
nowtime datetime default current_timestamp /* 현재 시간 */,
img varchar(255),	
file varchar(255),
day varchar(100)
,foreign key(ChatRoomId) references chat(ChatRoomId)
,foreign key(userno) references user(userno)
);

CREATE TABLE chat_user (
  ChatRoomId INT NOT NULL,
  UserNo INT NOT NULL,
  joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (ChatRoomId, UserNo),
  FOREIGN KEY (ChatRoomId) REFERENCES chat(ChatRoomId),
  FOREIGN KEY (UserNo) REFERENCES user(UserNo)
);

INSERT INTO friend (requester_id, receiver_id, status) VALUES 
('1', '1203', 2),
('1', '22', 2),
('1', '2025', 1);

select * from chat; 

select * from chating; 

select * from user;

select * from friend;

select * from chat_user;

update user set is_logged_in = 0 where userno= 1;

-- DROP TRIGGER update_chat_num_after_insert;
-- DROP TRIGGER update_chat_num_after_delete;

-- chat_user 테이블 사용 시, 인원수 자동 업데이트 트리거
-- DELIMITER //

-- CREATE TRIGGER update_chat_num_after_insert
-- AFTER INSERT ON chat_user
-- FOR EACH ROW
-- BEGIN
--   UPDATE chat 
--   SET num = (SELECT COUNT(*) FROM chatmembers WHERE ChatRoomId = NEW.ChatRoomId)
--   WHERE ChatRoomId = NEW.ChatRoomId;
-- END//

-- CREATE TRIGGER update_chat_num_after_delete
-- AFTER DELETE ON chat_user
-- FOR EACH ROW
-- BEGIN
--   UPDATE chat 
--   SET num = (SELECT COUNT(*) FROM chatmembers WHERE ChatRoomId = OLD.ChatRoomId)
--   WHERE ChatRoomId = OLD.ChatRoomId;
-- END//

-- DELIMITER ;

